{% import "components/log_table_component.html" as log_component %}
{% import "components/navbar_component.html" as navbar_component %}
{% import "components/incident_fill_component.html" as fill_component %}
<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Admin Side</title>
</head>

<body>
    {{ navbar_component.render_navbar(navbar) }}

    <main class="container mx-auto py-10 px-6 flex-grow bg-gray-100 text-gray-800 rounded-lg">
        <form method="POST" action="{{ url_for('admin_reg.handle_form') }}">
            <!-- Hidden inputs -->
            <input type="hidden" name="evakuert_id" value="{{ evakuert.EvakuertID if evakuert else '' }}">
            <input type="hidden" name="krise_id" id="krise_id" value="{{ evakuert.KriseID if evakuert else '' }}">
            <input type="hidden" name="kontakt_person_id" value="{{ evakuert.KontaktPersonID if evakuert else '' }}">
            <input type="hidden" name="status_id" value="{{ evakuert.StatusID if evakuert else '' }}">

            {{ fill_component.render_incident_fill(evakuert, kriser) }}

            <hr class="my-12 border-t border-gray-300">

            <!-- Evakuertes Info Section -->
            <h1 class="text-xl font-bold mb-4">Personlig Informasjon</h1>
            <div class="mb-6">
                <label class="text-center block font-bold mb-2">Evakuert Status</label>
                <div class="relative flex justify-center">
                    <button id="evak_status" type="button"
                        class="h-12 w-48 px-4 py-2 bg-white text-black border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 transition">
                        {{ evakuert.evak_status if evakuert and evakuert.evak_status else "Velg Status" }}
                    </button>
                    <ul id="dropdownMenu"
                    class="hidden absolute mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                    <li class="h-12 px-4 py-2 text-sm rounded-t bg-green-700 text-white hover:bg-green-600 cursor-pointer"
                        data-color="bg-green-700" data-value="1">OK</li>
                    <li class="h-12 px-4 py-2 text-sm bg-yellow-600 text-white hover:bg-yellow-500 cursor-pointer"
                        data-color="bg-yellow-600" data-value="2">Mindre skader</li>
                    <li class="h-12 px-4 py-2 text-sm rounded-b bg-red-700 text-white hover:bg-red-600 cursor-pointer"
                        data-color="bg-red-700" data-value="3">Kritisk</li>
                    </ul>
                    <input type="hidden" id="selected-status" name="status"
                        value="{{ evakuert.evak_status if evakuert and evakuert.evak_status else '' }}">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="evak-fnavn" class="block mb-1">Fornavn:</label>
                    <input id="evak-fnavn" type="text" name="evak-fnavn" placeholder="Ola"
                        class="border rounded p-2 w-full" value="{{ evakuert.evak_fnavn if evakuert else '' }}">
                </div>
                <div>
                    <label for="evak-mnavn" class="block mb-1">Mellomnavn:</label>
                    <input id="evak-mnavn" type="text" name="evak-mnavn" placeholder="Sylvert"
                        class="border rounded p-2 w-full" value="{{ evakuert.evak_mnavn if evakuert else '' }}">
                </div>
                <div>
                    <label for="evak-enavn" class="block mb-1">Etternavn:</label>
                    <input id="evak-enavn" type="text" name="evak-enavn" placeholder="Nordmann"
                        class="border rounded p-2 w-full" value="{{ evakuert.evak_enavn if evakuert else '' }}">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="evak-tlf" class="block mb-1">Tlf:</label>
                    <input id="evak-tlf" type="tel" name="evak-tlf" placeholder="Telefonnummer"
                        class="border rounded p-2 w-full" value="{{ evakuert.evak_tlf if evakuert else '' }}">
                </div>
                <div>
                    <label for="evak-adresse" class="block mb-1">Adresse:</label>
                    <input id="evak-adresse" type="text" name="evak-adresse" placeholder="Adresse"
                        class="border rounded p-2 w-full" value="{{ evakuert.evak_adresse if evakuert else '' }}">
                </div>
                <div>
                    <label for="evak-lokasjon" class="block mb-1">Lokasjon:</label>
                    <input id="evak-lokasjon" type="text" name="evak-lokasjon" placeholder="Hvor befinner du deg nå?"
                        class="border rounded p-2 w-full" value="{{ evakuert.evak_lokasjon if evakuert else '' }}">
                </div>
            </div>

            <h1 class="text-l text-center font-bold mb-4">Lokasjons logg</h1>
            <div class="">
                {{ log_component.render_log_table(logs) }}
            </div>

            <hr class="my-12 border-t border-gray-300">

            <!-- Kontaktperson Informasjon Section -->
            <h1 class="text-xl font-bold mb-4">Pårørende Info</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="kon-fnavn" class="block mb-1">Fornavn:</label>
                    <input id="kon-fnavn" type="text" name="kon-fnavn" placeholder="Ola"
                        class="border rounded p-2 w-full" value="{{ evakuert.kon_fnavn if evakuert else '' }}">
                </div>
                <div>
                    <label for="kon-mnavn" class="block mb-1">Mellomnavn:</label>
                    <input id="kon-mnavn" type="text" name="kon-mnavn" placeholder="Mellomnavn"
                        class="border rounded p-2 w-full" value="{{ evakuert.kon_mnavn if evakuert else '' }}">
                </div>
                <div>
                    <label for="kon-enavn" class="block mb-1">Etternavn:</label>
                    <input id="kon-enavn" type="text" name="kon-enavn" placeholder="Etternavn"
                        class="border rounded p-2 w-full" value="{{ evakuert.kon_enavn if evakuert else '' }}">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="kon-tlf" class="block mb-1">Tlf:</label>
                    <input id="kon-tlf" type="tel" name="kon-tlf" placeholder="Telefonnummer"
                        class="border rounded p-2 w-full" value="{{ evakuert.kon_tlf if evakuert else '' }}">
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="bg-gray-700 text-white px-6 py-2 rounded">Bekreft</button>
            </div>
        </form>
    </main>

    <script>
        // Existing dropdown for evakuert status
        const dropdownButton = document.getElementById('evak_status');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const dropdownOptions = dropdownMenu.querySelectorAll('li');

        document.querySelector("form").addEventListener("submit", function () {
            document.getElementById('selected-status').value = dropdownButton.textContent.trim();
            document.getElementById('selected-krise-status').value = kriseDropdownButton.textContent.trim();
        });

        dropdownButton.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (event) => {
            if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });

        dropdownOptions.forEach(option => {
            option.addEventListener('click', () => {
                const colorClass = option.getAttribute('data-color');
                const colorName = option.textContent;

                // Update the button background color and text
                dropdownButton.className = `w-full h-12 px-4 py-2 text-white border border-gray-300 rounded-md shadow-sm ${colorClass}`;
                dropdownButton.textContent = colorName;

                dropdownMenu.classList.add('hidden');
            });
        });

        // Krise status dropdown code (unchanged)
        const kriseDropdownButton = document.getElementById('krise-status');
        const kriseDropdownMenu = document.getElementById('kriseDropdownMenu');
        const kriseDropdownOptions = kriseDropdownMenu.querySelectorAll('li');
        kriseDropdownButton.addEventListener('click', () => {
            kriseDropdownMenu.classList.toggle('hidden');
        });
        document.addEventListener('click', (event) => {
            if (!kriseDropdownButton.contains(event.target) && !kriseDropdownMenu.contains(event.target)) {
                kriseDropdownMenu.classList.add('hidden');
            }
        });
        kriseDropdownOptions.forEach(option => {
            option.addEventListener('click', () => {
                const selectedValue = option.getAttribute('data-value');
                kriseDropdownButton.textContent = selectedValue;
                document.getElementById('selected-krise-status').value = selectedValue;
                kriseDropdownMenu.classList.add('hidden');
            });
        });

        // New dropdown for Krise navn
        const kriseNavnDropdownButton = document.getElementById('krise-navn-dropdown');
        const kriseNavnMenu = document.getElementById('krise-navn-menu');
        const kriseNavnOptions = kriseNavnMenu.querySelectorAll('li');
        
        kriseNavnDropdownButton.addEventListener('click', () => {
            kriseNavnMenu.classList.toggle('hidden');
        });
        
        document.addEventListener('click', (event) => {
            if (!kriseNavnDropdownButton.contains(event.target) && !kriseNavnMenu.contains(event.target)) {
                kriseNavnMenu.classList.add('hidden');
            }
        });
        
        kriseNavnOptions.forEach(option => {
            option.addEventListener('click', () => {
                const selectedId = option.getAttribute('data-id');
                const selectedName = option.getAttribute('data-name');
                
                // Update the dropdown button text and hidden fields for Krise ID and Name
                kriseNavnDropdownButton.textContent = selectedName;
                document.getElementById('krise_id').value = selectedId;
                document.getElementById('krise-navn').value = selectedName;
                
                // Hide the dropdown menu
                kriseNavnMenu.classList.add('hidden');

                // Fetch the crisis details from the backend using AJAX
                fetch(`/admin-reg/get_krise_details/${selectedId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.error) {
                            // Update the displayed fields
                            document.getElementById('krise-type').value = data.KriseSituasjonType;
                            document.getElementById('krise-lokasjon').value = data.Lokasjon;
                            document.getElementById('annen-info').value = data.Tekstboks;
                            
                            // Update the hidden fields so they are submitted with the form
                            document.getElementById('hidden-krise-type').value = data.KriseSituasjonType;
                            document.getElementById('hidden-krise-lokasjon').value = data.Lokasjon;
                            document.getElementById('hidden-annen-info').value = data.Tekstboks;
                            
                            // Optionally update Krise status if needed
                            kriseDropdownButton.textContent = data.Status;
                            document.getElementById('selected-krise-status').value = data.Status;
                        }
                    })
                    .catch(err => console.error("Error fetching crisis details:", err));
            });
        });

        // On form submission, ensure hidden fields are set
        document.querySelector("form").addEventListener("submit", function () {
            document.getElementById('selected-krise-status').value = kriseDropdownButton.textContent.trim();
        });
    </script>

</body>

</html>