<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ t['rfid_register_title'] }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 flex justify-center items-center min-h-screen text-black">

  <div class="bg-white px-10 py-6 rounded-2xl shadow-xl w-full max-w-2xl border border-gray-300">

    <!-- Top Row -->
    <div class="relative mb-8">
      <button onclick="history.back()" 
              class="absolute left-0 top-0 bg-gray-700 hover:bg-gray-800 text-white px-5 py-2 rounded-lg font-semibold shadow-md">
        ← {{ t['rfid_register_back'] }}
      </button>
      <h2 class="text-3xl font-extrabold text-gray-800 text-center">{{ t['rfid_register_heading'] }}</h2>
    </div>

    <!-- Evakuert ID Display -->
    <p class="text-xl text-gray-700 mb-6 text-center">
      {{ t['rfid_register_evakuert_id'] }}
      <span class="font-bold text-blue-600" id="evakuert-id">{{ evakuert_id }}</span>
    </p>

    <!-- Instructions -->
    <div class="text-lg text-gray-600 mb-6 text-center">
      <p>{{ t['rfid_register_instructions'] }}</p>
      <p id="scan-status" class="text-red-600 font-semibold mt-3 hidden">{{ t['rfid_register_scanning'] }}</p>
    </div>

    <!-- Scan Button -->
    <form id="rfid-form" class="space-y-4">
      <input type="hidden" id="evakuert_id" value="{{ evakuert_id }}">

      <button id="scan-btn" type="button"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold py-3 rounded-lg transition">
        {{ t['rfid_register_scan_button'] }}
      </button>
    </form>

    <!-- Success / Error Messages -->
    <div id="success-message" class="hidden mt-6 text-center">
      <p class="text-green-600 text-lg font-semibold mb-3">
        ✅ {{ t['rfid_register_success'] }}
      </p>
      <a href="{{ url_for('startID') }}"
         class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg shadow transition">
        {{ t['rfid_register_go_to_start'] }}
      </a>
    </div>

    <p id="error-message" class="hidden text-center text-red-500 text-lg font-semibold mt-5"></p>

  </div>

  <script>
    document.getElementById("scan-btn").addEventListener("click", async function () {
      const scanStatus = document.getElementById("scan-status");
      const successMessage = document.getElementById("success-message");
      const errorMessage = document.getElementById("error-message");
      const evakuertId = document.getElementById("evakuert-id").textContent;

      scanStatus.classList.remove("hidden");
      successMessage.classList.add("hidden");
      errorMessage.classList.add("hidden");

      try {
        const scanResponse = await fetch(`/api/scan`);
        const scanResult = await scanResponse.json();

        scanStatus.classList.add("hidden");

        if (scanResult.error) {
          errorMessage.textContent = scanResult.error;
          errorMessage.classList.remove("hidden");
          return;
        }

        const chipID = scanResult.uid;
        console.log(`✅ {{ t['rfid_register_scanned'] }}: ${chipID}`);

        if (scanResult.message === "{{ t['rfid_register_new_rfid_message'] }}") {
          const registerResponse = await fetch(`/api/register_new_rfid`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ evakuert_id: evakuertId, chip_id: chipID }),
          });

          const registerResult = await registerResponse.json();

          if (registerResult.error) {
            errorMessage.textContent = registerResult.error;
            errorMessage.classList.remove("hidden");
          } else {
            successMessage.classList.remove("hidden");
          }

        } else {
          successMessage.classList.remove("hidden");
        }

      } catch (error) {
        scanStatus.classList.add("hidden");
        errorMessage.textContent = "{{ t['rfid_register_error'] }}";
        errorMessage.classList.remove("hidden");
      }
    });
  </script>

</body>
</html>
